"0","# ### least squares method"
"0","# "
"0","# LSM <- function(n, d, S0, K, sigma, r, Time){"
"0","#  s0 <- S0/K"
"0","#  dt <- Time/d"
"0","#  z <- rnorm(n)"
"0","#  s.Time <- s0*exp((r-1/2*sigma^2)*Time+sigma*z*(Time^0.5))"
"0","#  s.Time[(n+1):(2*n)] <- s0*exp((r-1/2*sigma^2)*Time-sigma*z*(Time^0.5))"
"0","#  CC <- pmax(1-s.Time, 0)"
"0","#  payoffeu <- exp(-r*Time)*(CC[1:n]+CC[(n+1):(2*n)])/2*K"
"0","#  euprice <- mean(payoffeu)"
"0","# "
"0","#  for(k in (d-1):1){"
"0","#    z <- rnorm(n)"
"0","#    mean <- (log(s0) + k*log(s.Time[1:n]))/(k+1)"
"0","#    vol <- (k*dt/(k+1))^0.5*z"
"0","#    s.Time.1 <- exp(mean+sigma*vol)"
"0","#    mean <- (log(s0) + k*log( s.Time[(n+1):(2*n)] )) / ( k + 1 )"
"0","#    s.Time.1[(n+1):(2*n)] <- exp(mean-sigma*vol)"
"0","#    CE <- pmax(1-s.Time.1,0)"
"0","#    idx<-(1:(2*n))[CE>0]"
"0","#    discountedCC<- CC[idx]*exp(-r*dt)"
"0","#    basis1 <- exp(-s.Time.1[idx]/2)"
"0","#    basis2 <- basis1*(1-s.Time.1[idx])"
"0","#    basis3 <- basis1*(1-2*s.Time.1[idx]+(s.Time.1[idx]^2)/2)"
"0","# "
"0","#    p <- lm(discountedCC ~ basis1+basis2+basis3)$coefficients"
"0","#    estimatedCC <- p[1]+p[2]*basis1+p[3]*basis2+p[4]*basis3"
"0","#    EF <- rep(0, 2*n)"
"0","#    EF[idx] <- (CE[idx]>estimatedCC)"
"0","#    CC <- (EF == 0)*CC*exp(-r*dt)+(EF == 1)*CE"
"0","#    s.Time <- s.Time.1"
"0","#   }"
"0","# "
"0","#   payoff <- exp(-r*dt)*(CC[1:n]+CC[(n+1):(2*n)])/2"
"0","#   usprice <- mean(payoff*K)"
"0","#   error <- 1.96*sd(payoff*K)/sqrt(n)"
"0","#   earlyex <- usprice-euprice"
"0","#   data.frame(usprice, error, euprice)"
"0","# }"
"0","# S0 <- 36"
"0","# K <- 30"
"0","# Time <- 1"
"0","# r <- 0.05"
"0","# sigma <- 0.4"
"0","# LSM(10000, 3, S0, K, sigma, r, Time)"
